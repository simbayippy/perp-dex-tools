2025-11-05 16:21:51 | INFO     | SERVICE:FUNDING_RATE_SERVICE:log_level=INFO | FundingArbFeeCalculator initialized with 8 DEX fee structures
2025-11-05 16:21:53 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Using database credentials for account: acc1
2025-11-05 16:21:53 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Available exchanges: ['backpack', 'aster', 'lighter']
2025-11-05 16:21:53 | WARNING  | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Proxy assignments loaded but session proxy is disabled
2025-11-05 16:21:53 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Creating clients for exchanges: ['aster', 'lighter']
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Created 2 exchange clients: ['aster', 'lighter']
2025-11-05 16:21:55 | INFO     | SERVICE:FUNDING_RATE_SERVICE:log_level=INFO | FundingArbFeeCalculator initialized with 8 DEX fee structures
2025-11-05 16:21:55 | INFO     | SERVICE:FUNDING_RATE_SERVICE:log_level=INFO | OpportunityFinder initialized
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Strategy 'funding_arbitrage' created successfully
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Multi-symbol strategy: Contract attributes will be fetched per-symbol
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | === Trading Configuration ===
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Ticker: ALL
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Quantity: 1
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Exchange: lighter
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Strategy: funding_arbitrage
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Strategy Parameters:
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   scan_exchanges: ['aster', 'lighter']
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   mandatory_exchange: lighter
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   target_exposure: 120.0
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   max_positions: 1
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   max_total_exposure_usd: 200.0
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   min_profit_rate: 0.00022831050228310502
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   risk_strategy: combined
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   profit_erosion_threshold: 0.4
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   min_hold_hours: 2
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   max_position_age_hours: 168
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   max_new_positions_per_cycle: 1
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   limit_order_offset_pct: 0.0002
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   check_interval_seconds: 60
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   dry_run: False
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   max_oi_usd: 1500000.0
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   _config_path: configs/config.yml
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   _account_name: acc1
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   _account_credentials: {'backpack': {'secret_key': 'SYqtA6BbEuAa8KmmXCbpdTnSWmxKnIjwSLPCykFxeAk=', 'subaccount_index': 0, 'public_key': '7pGXGgpJMI1j2SrLIQFVeJyT9qM7kAMDUK/xZT+kICE='}, 'aster': {'api_key': '2b4fb053e2bb74ce374fde69a1e53273b7c65a0747337bd7046440679f0a184f', 'secret_key': 'b6e690df5ab7f47df476796229e94b9fec262b33a4b4cdeb50c94a25318ab05f', 'subaccount_index': 0}, 'lighter': {'subaccount_index': 0, 'private_key': '6b667422bcd62187a62a5a3b6b229cd40516ef8f3edf53fa8ce9a77f15f2451640ba2285cd71511e', 'account_index': '213803', 'api_key_index': '2'}}
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   _proxy_enabled: False
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   _proxy_egress_ip: None
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL |   _proxy_egress_source: None
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | =============================
2025-11-05 16:21:55 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Connecting to aster...
2025-11-05 16:21:57 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [ASTER] üîó Connected to ws
2025-11-05 16:21:57 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Connected to aster
2025-11-05 16:21:57 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Connecting to lighter...
2025-11-05 16:22:02 | DEBUG    | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] Client initialized (skipping API key validation to save rate limit)
2025-11-05 16:22:03 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] üîó Connected to websocket
2025-11-05 16:22:03 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] Websocket receive timeout: 45s (server handles ping/pong messages)
2025-11-05 16:22:05 | INFO     | BOT:FUNDING_ARBITRAGE:exchange=lighter:ticker=ALL | Connected to lighter
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | Database connection established
2025-11-05 16:22:06 | INFO     | SERVICE:FUNDING_RATE_SERVICE:log_level=INFO | DEXMapper loaded: 7 DEXs
2025-11-05 16:22:06 | DEBUG    | SERVICE:FUNDING_RATE_SERVICE:log_level=INFO | DEX mappings: {'lighter': 1, 'edgex': 2, 'paradex': 3, 'grvt': 4, 'hyperliquid': 5, 'backpack': 6, 'aster': 7}
2025-11-05 16:22:06 | INFO     | SERVICE:FUNDING_RATE_SERVICE:log_level=INFO | SymbolMapper loaded: 331 symbols
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | Loaded account_id b1fb8811-b6f5-4b8c-8586-44d6517cb785 for account 'acc1'
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | Position manager initialized with 0 open positions (account: acc1)
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | FundingArbitrageStrategy initialized successfully
2025-11-05 16:22:06 | DEBUG    | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | Started background monitor loop
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | Strategy 'Funding Rate Arbitrage' initialized
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | Scanning for new funding arbitrage opportunities
2025-11-05 16:22:06 | INFO     | SERVICE:FUNDING_RATE_SERVICE:log_level=INFO | Found 3 raw opportunities, 3 after filtering, returning top 3
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | ‚è≠Ô∏è  Skipped CC opportunities (temporary filter)
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | Found 2 opportunities
2025-11-05 16:22:06 | DEBUG    | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | No open positions to monitor for account acc1
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | =======================================================
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | 1. üìã TOSHI ‚Ä¢ Opportunity Validation
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | =======================================================
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | Ensuring TOSHI is tradeable on both lighter and aster
2025-11-05 16:22:06 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | üîß [LIGHTER] Initializing contract attributes for TOSHI
2025-11-05 16:22:06 | DEBUG    | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] Looking for ticker 'TOSHI' as '1000TOSHI' in Lighter markets
2025-11-05 16:22:08 | DEBUG    | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] Minimum order notional for TOSHI: $10.000000
2025-11-05 16:22:08 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | ‚úÖ [LIGHTER] TOSHI initialized ‚Üí contract_id=81, tick_size=0.0001
2025-11-05 16:22:08 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | üîß [ASTER] Initializing contract attributes for TOSHI
2025-11-05 16:22:08 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | üîç [ASTER] Found 144 tradeable symbols. Looking for TOSHIUSDT...
2025-11-05 16:22:08 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | üîç [ASTER] Found TOSHIUSDT with status: TRADING
2025-11-05 16:22:08 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | üìê [ASTER] TOSHIUSDT filters: tick_size=1E-7, step_size=1, min_qty=1, min_notional=5
2025-11-05 16:22:08 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | ‚úÖ [ASTER] TOSHI initialized ‚Üí contract_id=TOSHIUSDT, tick_size=1E-7
2025-11-05 16:22:08 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | ‚úÖ TOSHI available on both LIGHTER and ASTER
2025-11-05 16:22:08 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | =======================================================
2025-11-05 16:22:08 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | 2. üîç Leverage Validation & Normalization
2025-11-05 16:22:08 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | =======================================================
2025-11-05 16:22:08 | DEBUG    | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] Cache miss for TOSHI, fetching all markets (300 weight)
2025-11-05 16:22:08 | DEBUG    | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] Cached market_id=81 for TOSHI (and 102 other markets)
2025-11-05 16:22:09 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | üìä [LIGHTER] Leverage info for TOSHI:
  - Symbol max leverage: 3.0x
  - Account leverage: 300.0300030003000300030003000x
  - Max notional: None
  - Margin requirement: 0.3333 (33.3%)
2025-11-05 16:22:09 | DEBUG    | CORE:LEVERAGE_VALIDATOR             | ‚úÖ [LIGHTER] Leverage info for TOSHI: LeverageInfo(lighter:TOSHI, leverage=3.000300030003000300030003000x, margin=33.3%)
2025-11-05 16:22:09 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] get_account_balance WebSocket user_stats not available, using REST fallback (300 weight)
2025-11-05 16:22:10 | DEBUG    | CORE:LEVERAGE_VALIDATOR             | ‚úÖ [LIGHTER] Can support $120.00 (max: $153.3117941794179417941794179)
2025-11-05 16:22:10 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | [ASTER] Leverage brackets API response for TOSHI: [{'symbol': 'TOSHIUSDT', 'brackets': [{'bracket': 1, 'initialLeverage': 5, 'notionalCap': 100000, 'notionalFloor': 0, 'maintMarginRatio': 0.01, 'cum': 0.0}, {'bracket': 2, 'initialLeverage': 4, 'notionalCap': 500000, 'notionalFloor': 100000, 'maintMarginRatio': 0.125, 'cum': 11500.0}, {'bracket': 3, 'initialLeverage': 3, 'notionalCap': 2000000, 'notionalFloor': 500000, 'maintMarginRatio': 0.166, 'cum': 32000.0}, {'bracket': 4, 'initialLeverage': 2, 'notionalCap': 6000000, 'notionalFloor': 2000000, 'maintMarginRatio': 0.25, 'cum': 200000.0}, {'bracket': 5, 'initialLeverage': 1, 'notionalCap': 12000000, 'notionalFloor': 6000000, 'maintMarginRatio': 0.5, 'cum': 1700000.0}]}]
2025-11-05 16:22:10 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | üìä [ASTER] Account leverage for TOSHI: 3x
2025-11-05 16:22:10 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üìä [ASTER] Leverage info for TOSHI:
  - Symbol max leverage: 5x
  - Account leverage: 3x
  - Max notional: $12000000
  - Margin requirement: 0.3333333333333333333333333333 (33.3%)
2025-11-05 16:22:10 | DEBUG    | CORE:LEVERAGE_VALIDATOR             | ‚úÖ [ASTER] Leverage info for TOSHI: LeverageInfo(aster:TOSHI, leverage=5x, max_notional=$12000000, margin=33.3%)
2025-11-05 16:22:10 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | [ASTER] Available balance: $256.20
2025-11-05 16:22:10 | DEBUG    | CORE:LEVERAGE_VALIDATOR             | ‚úÖ [ASTER] Can support $120.00 (max: $768.6002102400000000000000001)
2025-11-05 16:22:10 | INFO     | CORE:LEVERAGE_VALIDATOR             | ‚úÖ [LEVERAGE] Position size $120.00 supported by all exchanges
2025-11-05 16:22:10 | INFO     | CORE:LEVERAGE_VALIDATOR             | üìä [LIGHTER] Max leverage for TOSHI: 3x
2025-11-05 16:22:10 | INFO     | CORE:LEVERAGE_VALIDATOR             | üìä [ASTER] Max leverage for TOSHI: 5x
2025-11-05 16:22:10 | INFO     | CORE:LEVERAGE_VALIDATOR             | üîß [LEVERAGE] Normalizing to minimum leverage: 3x (limited by lighter)
2025-11-05 16:22:10 | WARNING  | CORE:LEVERAGE_VALIDATOR             | ‚ö†Ô∏è  [LIGHTER] Does not support set_account_leverage(), skipping
2025-11-05 16:22:10 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [ASTER] Setting leverage for TOSHI to 3x...
2025-11-05 16:22:10 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | POST /fapi/v1/leverage - Params: {'timestamp': 1762359730859, 'recvWindow': 5000}, Data: {'symbol': 'TOSHIUSDT', 'leverage': 3}
2025-11-05 16:22:11 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Response 200: N/A
2025-11-05 16:22:11 | INFO     | CORE:LEVERAGE_VALIDATOR             | ‚úÖ [ASTER] Leverage set to 3x for TOSHI
2025-11-05 16:22:11 | INFO     | CORE:LEVERAGE_VALIDATOR             | ‚úÖ [LEVERAGE] All exchanges normalized to 3x for TOSHI
2025-11-05 16:22:11 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | üéØ Execution plan for TOSHI: Long LIGHTER ($120.00) | Short ASTER ($120.00) | Divergence 0.104%
2025-11-05 16:22:11 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | =======================================================
2025-11-05 16:22:11 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | 3. üß® Atomic Multi-Order Execution
2025-11-05 16:22:11 | INFO     | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | =======================================================
2025-11-05 16:22:11 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] üîÑ Switching order book from market  to 81
2025-11-05 16:22:11 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] Order book snapshot loaded with 47 bids and 64 asks (BBO: 0.5539/0.5553)
2025-11-05 16:22:11 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] ‚úÖ Switched order book from market  to 81 (47 bids, 64 asks) | config.contract_id updated to 81
2025-11-05 16:22:11 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üìä Connecting to Aster book ticker: toshiusdt@bookTicker
2025-11-05 16:22:13 | INFO     | EXCHANGE:ASTER:ticker=ALL           | ‚úÖ Connected to Aster book ticker for TOSHIUSDT
2025-11-05 16:22:14 | INFO     | EXCHANGE:ASTER:ticker=ALL           | ‚úÖ Book ticker ready: bid=0.000553, ask=0.0005556
2025-11-05 16:22:14 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üìö [ASTER] Connecting to depth stream: toshiusdt@depth20@100ms
2025-11-05 16:22:15 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üìö [ASTER] Connected to depth stream for TOSHIUSDT
2025-11-05 16:22:16 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üìö [ASTER] ‚úÖ Depth stream ready for TOSHIUSDT (20 bids, 20 asks)
2025-11-05 16:22:16 | INFO     | CORE:PRICE_PROVIDER                 | ‚úÖ [LIGHTER] BBO: bid=0.5544, ask=0.5553
2025-11-05 16:22:16 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üì° [ASTER] Using real-time BBO from WebSocket
2025-11-05 16:22:16 | INFO     | CORE:PRICE_PROVIDER                 | ‚úÖ [ASTER] BBO: bid=0.0005547, ask=0.000556
2025-11-05 16:22:16 | DEBUG    | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | üìä [MULTIPLIER] TOSHI: long=216.09 (√ó1000), short=216090 (√ó1) = 216090.00 tokens
2025-11-05 16:22:16 | DEBUG    | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | üìè Planned execution for TOSHI: qty=216.09 (long‚âà$119.99, short‚âà$119.87)
2025-11-05 16:22:16 | INFO     | CORE:ATOMIC_MULTI_ORDER             | Starting atomic execution of 2 orders (rollback_on_partial=True)
2025-11-05 16:22:16 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:16 | INFO     | CORE:ATOMIC_MULTI_ORDER             | 3.1. üîç Pre-flight Checks
2025-11-05 16:22:16 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:16 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:16 | INFO     | CORE:ATOMIC_MULTI_ORDER             | 3.1.2. üí∞ Margin & Balance Checks
2025-11-05 16:22:16 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:16 | INFO     | CORE:ATOMIC_MULTI_ORDER             | Running balance checks...
2025-11-05 16:22:16 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] get_account_balance WebSocket user_stats not available, using REST fallback (300 weight)
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | ‚úÖ lighter balance OK: $51.10 >= $26.40
2025-11-05 16:22:17 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | [ASTER] Available balance: $256.20
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | ‚úÖ aster balance OK: $256.20 >= $26.37
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | 3.1.3. üåä Order Book Liquidity
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | Running liquidity checks...
2025-11-05 16:22:17 | DEBUG    | CORE:ATOMIC_MULTI_ORDER             | Checking liquidity for order 0: buy TOSHI $119.994777
2025-11-05 16:22:17 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | üì° [LIGHTER] Using real-time order book from WebSocket (20 bids, 20 asks)
2025-11-05 16:22:17 | INFO     | CORE:LIQUIDITY_ANALYZER             | üìä [LIQUIDITY-lighter] TOSHI: 20 bids, 20 asks | Best: 0.5545/0.5558 | Spread: 23 bps
2025-11-05 16:22:17 | INFO     | CORE:LIQUIDITY_ANALYZER             | üìà [LIQUIDITY-lighter] Fill analysis: Can fill: True, Levels needed: 1/20, Total available: $119.99
2025-11-05 16:22:17 | INFO     | CORE:LIQUIDITY_ANALYZER             | ‚úÖ [LIQUIDITY-lighter] VERDICT for buy $119.994777 TOSHI: Recommendation='use_limit' | Score=0.95 | Slippage=0.000% | Spread=23bps
2025-11-05 16:22:17 | DEBUG    | CORE:ATOMIC_MULTI_ORDER             | Checking liquidity for order 1: sell TOSHI $119.8651230
2025-11-05 16:22:17 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üì° [ASTER] Using real-time order book from WebSocket (20 bids, 20 asks)
2025-11-05 16:22:17 | INFO     | CORE:LIQUIDITY_ANALYZER             | üìä [LIQUIDITY-aster] TOSHI: 20 bids, 20 asks | Best: 0.0005546/0.0005560 | Spread: 25 bps
2025-11-05 16:22:17 | INFO     | CORE:LIQUIDITY_ANALYZER             | üìà [LIQUIDITY-aster] Fill analysis: Can fill: True, Levels needed: 1/20, Total available: $119.87
2025-11-05 16:22:17 | INFO     | CORE:LIQUIDITY_ANALYZER             | ‚úÖ [LIQUIDITY-aster] VERDICT for sell $119.8651230 TOSHI: Recommendation='use_limit' | Score=0.95 | Slippage=0.000% | Spread=25bps
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | 3.1.4. üíµ Minimum Order Notional
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | Validating minimum notional requirements...
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | ‚úÖ [LIGHTER] TOSHI notional $119.99 meets minimum $10.00
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | ‚úÖ [ASTER] TOSHI notional $119.87 meets minimum $5.00
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | ‚úÖ All pre-flight checks passed
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | 3.2. üöÄ Order Placement
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:17 | INFO     | CORE:ATOMIC_MULTI_ORDER             | üöÄ Placing all orders simultaneously...
2025-11-05 16:22:17 | INFO     | CORE:ORDER_EXECUTOR                 | üü¢ [LIGHTER] Executing buy TOSHI ($119.994777 qty=216.09) in mode limit_only
2025-11-05 16:22:17 | INFO     | CORE:PRICE_PROVIDER                 | ‚úÖ [LIGHTER] BBO: bid=0.5545, ask=0.5558
2025-11-05 16:22:17 | INFO     | CORE:ORDER_EXECUTOR                 | [LIGHTER] Placing limit buy TOSHI (contract_id=81): 216.09 @ $0.55568884 (mid: $0.55515, offset: 0.0200%)
2025-11-05 16:22:17 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | üì§ [LIGHTER] Submitting order: market=81 client_id=737976 side=BID price=5557 amount=21609
2025-11-05 16:22:17 | INFO     | CORE:ORDER_EXECUTOR                 | üî¥ [ASTER] Executing sell TOSHI ($119.8651230 qty=216090) in mode limit_only
2025-11-05 16:22:18 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üì° [ASTER] Using real-time BBO from WebSocket
2025-11-05 16:22:18 | INFO     | CORE:PRICE_PROVIDER                 | ‚úÖ [ASTER] BBO: bid=0.0005546, ask=0.000556
2025-11-05 16:22:18 | INFO     | CORE:ORDER_EXECUTOR                 | [ASTER] Placing limit sell TOSHI (contract_id=TOSHIUSDT): 216090 @ $0.00055471092 (mid: $0.0005553, offset: 0.0200%)
2025-11-05 16:22:18 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] OPEN 216090 @ 0.0005547

**ERROR HERE!!!** - the order was cancelled by the exchange as it violates the post-only rule. This means it crosses the order book, and is no longer acting as a maker order, but a taker
2025-11-05 16:22:20 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | [WEBSOCKET] [LIGHTER] CANCELED-POST-ONLY 0.00 @ 0.5557

2025-11-05 16:22:25 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] PARTIALLY_FILLED 43218 @ 0.0005547
2025-11-05 16:22:26 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] PARTIALLY_FILLED 55556 @ 0.0005547
2025-11-05 16:22:38 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] PARTIALLY_FILLED 87663 @ 0.0005547
2025-11-05 16:22:49 | WARNING  | CORE:ORDER_EXECUTOR                 | [LIGHTER] Limit order timeout after 30.0s, canceling 737976
2025-11-05 16:22:50 | WARNING  | CORE:ORDER_EXECUTOR                 | [ASTER] Limit order timeout after 30.0s, canceling 130167083
2025-11-05 16:22:50 | INFO     | CORE:ORDER_EXECUTOR                 | [ASTER] Limit order 130167083 limit_timeout after partial fill 87663 @ $0.0005547
2025-11-05 16:22:50 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] CANCELED 87663 @ 0.0005547
2025-11-05 16:22:53 | DEBUG    | CORE:ATOMIC_MULTI_ORDER             | üìä Multiplier adjustment for TOSHI: trigger_qty=87663 (√ó1) ‚Üí target_qty=87.663 (√ó1000)
2025-11-05 16:22:54 | DEBUG    | CORE:ATOMIC_MULTI_ORDER             | [ASTER] TOSHI: Significant remainder 128427 (59.4% of 216090)
2025-11-05 16:22:54 | INFO     | CORE:ATOMIC_MULTI_ORDER             | üîÅ Initiating retry cycle for unmatched legs.
2025-11-05 16:22:54 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:54 | INFO     | CORE:ATOMIC_MULTI_ORDER             | 3.2.retry.1. üîÅ Retry Attempt 1
2025-11-05 16:22:54 | INFO     | CORE:ATOMIC_MULTI_ORDER             | =======================================================
2025-11-05 16:22:54 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üì° [ASTER] Using real-time BBO from WebSocket
2025-11-05 16:22:54 | INFO     | CORE:PRICE_PROVIDER                 | ‚úÖ [ASTER] BBO: bid=0.000554, ask=0.0005554
2025-11-05 16:22:54 | INFO     | CORE:ORDER_EXECUTOR                 | üî¥ [ASTER] Executing sell TOSHI ($71.148558 qty=128427) in mode limit_only
2025-11-05 16:22:54 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üì° [ASTER] Using real-time BBO from WebSocket
2025-11-05 16:22:54 | INFO     | CORE:PRICE_PROVIDER                 | ‚úÖ [ASTER] BBO: bid=0.000554, ask=0.0005554
2025-11-05 16:22:54 | INFO     | CORE:ORDER_EXECUTOR                 | [ASTER] Placing limit sell TOSHI (contract_id=TOSHIUSDT): 128427 @ $0.0005541108 (mid: $0.0005547, offset: 0.0200%)
2025-11-05 16:22:54 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Using contract_id for order: 'TOSHIUSDT'
2025-11-05 16:22:54 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Rounded quantity: 128427.0 ‚Üí 128427 (step_size=1)
2025-11-05 16:22:54 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Rounded price to tick_size: 0.0005541108 ‚Üí 0.0005541 (tick_size=1E-7, symbol=TOSHIUSDT)
2025-11-05 16:22:54 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Placing SELL limit order: 128427 @ 0.0005541
2025-11-05 16:22:54 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | POST /fapi/v1/order - Params: {'timestamp': 1762359774134, 'recvWindow': 5000}, Data: {'symbol': 'TOSHIUSDT', 'side': 'SELL', 'type': 'LIMIT', 'quantity': '128427', 'price': '0.0005541', 'timeInForce': 'GTX'}
2025-11-05 16:22:54 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Response 200: 130167264
2025-11-05 16:22:54 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] OPEN 128427 @ 0.0005541
2025-11-05 16:22:56 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Unknown WebSocket message: {'e': 'ACCOUNT_UPDATE', 'T': 1762359775969, 'E': 1762359775970, 'a': {'B': [{'a': 'USDT', 'wb': '256.24817333', 'cw': '256.24817333', 'bc': '0'}], 'P': [{'s': 'TOSHIUSDT', 'pa': '-113348', 'ep': '0.00055456', 'cr': '-8.03919723', 'up': '-0.02266960', 'mt': 'cross', 'iw': '0', 'ps': 'BOTH', 'ma': 'USDT'}], 'm': 'ORDER'}}
2025-11-05 16:22:56 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] PARTIALLY_FILLED 25685 @ 0.0005541
2025-11-05 16:22:57 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Unknown WebSocket message: {'e': 'ACCOUNT_UPDATE', 'T': 1762359777555, 'E': 1762359777556, 'a': {'B': [{'a': 'USDT', 'wb': '256.24760405', 'cw': '256.24760405', 'bc': '0'}], 'P': [{'s': 'TOSHIUSDT', 'pa': '-133896', 'ep': '0.00055449', 'cr': '-8.03919723', 'up': '-0.00803376', 'mt': 'cross', 'iw': '0', 'ps': 'BOTH', 'ma': 'USDT'}], 'm': 'ORDER'}}
2025-11-05 16:22:57 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] PARTIALLY_FILLED 46233 @ 0.0005541
2025-11-05 16:22:58 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Unknown WebSocket message: {'e': 'ACCOUNT_UPDATE', 'T': 1762359778784, 'E': 1762359778787, 'a': {'B': [{'a': 'USDT', 'wb': '256.24714861', 'cw': '256.24714861', 'bc': '0'}], 'P': [{'s': 'TOSHIUSDT', 'pa': '-150335', 'ep': '0.00055445', 'cr': '-8.03919723', 'up': '-0.00902010', 'mt': 'cross', 'iw': '0', 'ps': 'BOTH', 'ma': 'USDT'}], 'm': 'ORDER'}}
2025-11-05 16:22:58 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] PARTIALLY_FILLED 62672 @ 0.0005541
2025-11-05 16:23:00 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Unknown WebSocket message: {'e': 'ACCOUNT_UPDATE', 'T': 1762359780441, 'E': 1762359780443, 'a': {'B': [{'a': 'USDT', 'wb': '256.24678427', 'cw': '256.24678427', 'bc': '0'}], 'P': [{'s': 'TOSHIUSDT', 'pa': '-163486', 'ep': '0.00055442', 'cr': '-8.03919723', 'up': '-0.03433206', 'mt': 'cross', 'iw': '0', 'ps': 'BOTH', 'ma': 'USDT'}], 'm': 'ORDER'}}
2025-11-05 16:23:00 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] PARTIALLY_FILLED 75823 @ 0.0005541
2025-11-05 16:23:01 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Unknown WebSocket message: {'e': 'ACCOUNT_UPDATE', 'T': 1762359781761, 'E': 1762359781763, 'a': {'B': [{'a': 'USDT', 'wb': '256.24649279', 'cw': '256.24649279', 'bc': '0'}], 'P': [{'s': 'TOSHIUSDT', 'pa': '-174007', 'ep': '0.00055440', 'cr': '-8.03919723', 'up': '-0.03654147', 'mt': 'cross', 'iw': '0', 'ps': 'BOTH', 'ma': 'USDT'}], 'm': 'ORDER'}}
2025-11-05 16:23:01 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] PARTIALLY_FILLED 86344 @ 0.0005541
2025-11-05 16:23:03 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Unknown WebSocket message: {'e': 'ACCOUNT_UPDATE', 'T': 1762359783320, 'E': 1762359783321, 'a': {'B': [{'a': 'USDT', 'wb': '256.24643068', 'cw': '256.24643068', 'bc': '0'}], 'P': [{'s': 'TOSHIUSDT', 'pa': '-176249', 'ep': '0.00055440', 'cr': '-8.03919723', 'up': '-0.04582474', 'mt': 'cross', 'iw': '0', 'ps': 'BOTH', 'ma': 'USDT'}], 'm': 'ORDER'}}
2025-11-05 16:23:03 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] PARTIALLY_FILLED 88586 @ 0.0005541
2025-11-05 16:23:06 | DEBUG    | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | No open positions to monitor for account acc1
2025-11-05 16:23:16 | WARNING  | CORE:ORDER_EXECUTOR                 | [ASTER] Limit order timeout after 20.0s, canceling 130167264
2025-11-05 16:23:16 | INFO     | CORE:ORDER_EXECUTOR                 | [ASTER] Limit order 130167264 limit_timeout after partial fill 88586 @ $0.0005541
2025-11-05 16:23:16 | WARNING  | CORE:ATOMIC_MULTI_ORDER             | ‚ö†Ô∏è Critical imbalance detected during retry attempt 1: longs=$119.99, shorts=$97.71, imbalance=$22.28 (18.6%). Aborting retries for safety.
2025-11-05 16:23:16 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] CANCELED 88586 @ 0.0005541
2025-11-05 16:23:16 | WARNING  | CORE:ATOMIC_MULTI_ORDER             | ‚ö†Ô∏è CRITICAL IMBALANCE after retry failure: longs=$119.99, shorts=$97.71, imbalance=$22.28 (18.6%). Triggering emergency rollback.
2025-11-05 16:23:16 | WARNING  | CORE:ATOMIC_MULTI_ORDER             | üö® EMERGENCY ROLLBACK: Closing 2 filled orders
2025-11-05 16:23:16 | INFO     | CORE:ATOMIC_MULTI_ORDER             | Step 1/3: Canceling all orders to prevent further fills...
2025-11-05 16:23:18 | INFO     | CORE:ATOMIC_MULTI_ORDER             | Step 2/3: Querying actual filled amounts...
2025-11-05 16:23:18 | INFO     | CORE:ATOMIC_MULTI_ORDER             | Step 3/3: Closing 2 filled positions...
2025-11-05 16:23:18 | INFO     | CORE:ATOMIC_MULTI_ORDER             | Rollback: sell TOSHI 216.09 @ market
2025-11-05 16:23:18 | DEBUG    | CORE:ATOMIC_MULTI_ORDER             | Rollback: Using contract_id='81' for symbol 'TOSHI'
2025-11-05 16:23:18 | INFO     | CORE:ATOMIC_MULTI_ORDER             | Rollback: buy TOSHI 88586 @ market
2025-11-05 16:23:18 | DEBUG    | CORE:ATOMIC_MULTI_ORDER             | Rollback: Using contract_id='TOSHIUSDT' for symbol 'TOSHI'
2025-11-05 16:23:18 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | üì§ [LIGHTER] Placing market order: market=81, client_id=798767, side=SELL, base_amount=21609, avg_execution_price=5271
2025-11-05 16:23:18 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | üîç [ASTER] Using contract_id for market order: 'TOSHIUSDT'
2025-11-05 16:23:18 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | üìê [ASTER] Rounded quantity: 88586.0 ‚Üí 88586
2025-11-05 16:23:18 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üì° [ASTER] Using real-time BBO from WebSocket
2025-11-05 16:23:18 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üìä [ASTER] Market order BBO check: bid=0.0005546, ask=0.0005561
2025-11-05 16:23:18 | INFO     | EXCHANGE:ASTER:ticker=ALL           | üì§ [ASTER] Placing market BUY order: 88586 @ ~$0.0005561
2025-11-05 16:23:18 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | POST /fapi/v1/order - Params: {'timestamp': 1762359798783, 'recvWindow': 5000}, Data: {'symbol': 'TOSHIUSDT', 'side': 'BUY', 'type': 'MARKET', 'quantity': '88586'}
2025-11-05 16:23:19 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Response 200: 130167356
2025-11-05 16:23:19 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] OPEN 88586 @ n/a
2025-11-05 16:23:19 | DEBUG    | EXCHANGE:ASTER:ticker=ALL           | Unknown WebSocket message: {'e': 'ACCOUNT_UPDATE', 'T': 1762359799180, 'E': 1762359799183, 'a': {'B': [{'a': 'USDT', 'wb': '256.06712810', 'cw': '256.06712810', 'bc': '0'}], 'P': [{'s': 'TOSHIUSDT', 'pa': '-87663', 'ep': '0.00055440', 'cr': '-8.19879120', 'up': '-0.02629890', 'mt': 'cross', 'iw': '0', 'ps': 'BOTH', 'ma': 'USDT'}], 'm': 'ORDER'}}
2025-11-05 16:23:19 | INFO     | EXCHANGE:ASTER:ticker=ALL           | [WEBSOCKET] [ASTER] FILLED 88586 @ n/a
2025-11-05 16:23:19 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | [WEBSOCKET] [LIGHTER] FILLED 216.09 @ 0.5271
2025-11-05 16:23:19 | INFO     | EXCHANGE:LIGHTER:ticker=ALL         | TRANSACTION: SELL 216.09 @ 0.5271 | Order: 798767 | Status: FILLED
2025-11-05 16:23:19 | DEBUG    | EXCHANGE:LIGHTER:ticker=ALL         | [LIGHTER] Received user stats via WebSocket: balance=11.044576 (0 weight)
2025-11-05 16:23:19 | INFO     | EXCHANGE:ASTER:ticker=ALL           | ‚úÖ [ASTER] Market order filled: 130167356
2025-11-05 16:23:19 | WARNING  | CORE:ATOMIC_MULTI_ORDER             | Rollback cost for TOSHI: $0.00 (entry: $0.5557, exit: $0.5557)
2025-11-05 16:23:19 | WARNING  | CORE:ATOMIC_MULTI_ORDER             | Rollback cost for TOSHI: $0.00 (entry: $0.0005541, exit: $0.0005541)
2025-11-05 16:23:19 | WARNING  | CORE:ATOMIC_MULTI_ORDER             | ‚úÖ Rollback complete. Total cost: $0.00
2025-11-05 16:23:19 | WARNING  | CORE:ATOMIC_MULTI_ORDER             | üõ°Ô∏è Emergency rollback completed; cost=$0.0000. Prevented $22.28 (18.6%) directional exposure.
2025-11-05 16:23:19 | ERROR    | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | ‚ùå TOSHI: Atomic execution failed - Rolled back after hedge failure
2025-11-05 16:23:19 | WARNING  | STRATEGY:FUNDING_RATE_ARBITRAGE:exchange=lighter:ticker=ALL:account=acc1 | üîÑ Emergency rollback performed, cost: $0.00

**NEXT ERROR!!!** - despite it saying that theemergency rollback was successful, we are still directionally exposed

- lighter, ended up with the full position size (it did a market fill first, based on the amount aster had) (had 216.09)
- aster, did 2 limit orders? one filled for (rougly, see logs above) 87.6, another filled for 88.5, leaving 87.6 still unsold

do we need a better rollback mechanism? to ensure that both sides will be FULLY CLOSED!!



BASICALLY, 2 ERRORS

1. lighter not handling when we cross order book. should we just make a function to handle this across all exchanges?
2. emergency rollback is not working as expected. we need to ensure that both sides will be FULLY CLOSED!!